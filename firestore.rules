rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ================= HELPERS ================= */
    function signedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && userDoc().data.role == "admin";
    }

    /* ================= USERS ================= */
    match /users/{userId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.auth.uid == userId;
      allow update, delete: if signedIn() &&
        (request.auth.uid == userId || isAdmin());
    }

    /* ================= PRODUCTS ================= */
    match /products/{productId} {
      allow read: if true;

      allow create: if signedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.approved == false;

      allow update: if isAdmin() ||
        (
          signedIn()
          && resource.data.userId == request.auth.uid
          && !("approved" in request.resource.data)
          && !("featured" in request.resource.data)
          && !("promoted" in request.resource.data)
        );

      allow delete: if isAdmin() ||
        (signedIn() && resource.data.userId == request.auth.uid);
    }

    /* ================= ORDERS ================= */
    match /orders/{orderId} {
      allow create: if signedIn()
        && request.auth.uid == request.resource.data.buyerId;

      allow read: if isAdmin() ||
        (
          signedIn() &&
          (
            request.auth.uid == resource.data.buyerId ||
            request.auth.uid == resource.data.sellerId
          )
        );

      allow update: if isAdmin();
      allow delete: if false;
    }

    /* ================= PROMOTION PLANS ================= */
    match /promotionPlans/{planId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /* ================= FAVORITES ================= */
    match /users/{userId}/favorites/{favId} {
      allow read, write: if signedIn() && request.auth.uid == userId;
    }

    /* ================= CONVERSATIONS ================= */
    match /conversations/{conversationId} {

      /* READ SINGLE CONVERSATION */
      allow get: if signedIn() &&
        (
          request.auth.uid == resource.data.buyerId ||
          request.auth.uid == resource.data.sellerId ||
          isAdmin()
        );

      /* LIST / QUERY (IMPORTANT: no resource.data here) */
      allow list: if signedIn();

      /* CREATE CONVERSATION */
      allow create: if signedIn()
        && request.resource.data.buyerId == request.auth.uid
        && request.resource.data.sellerId != request.auth.uid
        && request.auth.uid in request.resource.data.participants
        && request.resource.data.productId is string;

      /* UPDATE CONVERSATION (only allowed fields) */
     allow update: if signedIn() &&
(
  request.auth.uid == resource.data.buyerId ||
  request.auth.uid == resource.data.sellerId ||
  isAdmin()
) &&
request.resource.data
  .diff(resource.data)
  .changedKeys()
  .hasOnly([
    "lastMessage",
    "lastMessageAt",
    "buyerUnread",
    "sellerUnread",
    "buyerTyping",
    "sellerTyping",
    "updatedAt",
    "lastMessageSenderId"
  ]);

      allow delete: if isAdmin();

      /* ================= MESSAGES ================= */
      match /messages/{messageId} {

        /* READ MESSAGES */
        allow read: if signedIn() &&
          (
            request.auth.uid ==
              get(/databases/$(database)/documents/conversations/$(conversationId)).data.buyerId ||
            request.auth.uid ==
              get(/databases/$(database)/documents/conversations/$(conversationId)).data.sellerId ||
            isAdmin()
          );

        /* SEND MESSAGE */
        allow create: if signedIn()
          && request.auth.uid == request.resource.data.senderId
          && (
            request.auth.uid ==
              get(/databases/$(database)/documents/conversations/$(conversationId)).data.buyerId ||
            request.auth.uid ==
              get(/databases/$(database)/documents/conversations/$(conversationId)).data.sellerId
          );

        /* SOFT DELETE MESSAGE */
        allow update: if signedIn()
          && request.auth.uid == resource.data.senderId
          && request.resource.data.keys().hasOnly([
            "isDeleted",
            "deletedAt"
          ]);

        allow delete: if false;
      }
    }

    /* ================= NOTIFICATIONS ================= */
    match /notifications/{notificationId} {
      allow create: if signedIn();
      allow read: if signedIn()
        && request.auth.uid == resource.data.userId;
      allow update: if false;
      allow delete: if signedIn()
        && request.auth.uid == resource.data.userId;
    }

    /* ================= FCM TOKENS ================= */
    match /fcmTokens/{userId} {
      allow create, update, delete: if signedIn()
        && request.auth.uid == userId;
      allow read: if false;
    }

    /* ================= REPORTS ================= */
    match /reports/{reportId} {
      allow create: if signedIn();
      allow read, update, delete: if isAdmin();
    }

    /* ================= DENY ALL ================= */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
